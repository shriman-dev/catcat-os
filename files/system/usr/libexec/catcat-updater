#!/bin/bash

REG_FLATPAK_APPS_UPDATE=(
  "org.mozilla.firefox"
  "io.gitlab.librewolf-community"
  "net.mullvad.MullvadBrowser"
  "org.garudalinux.firedragon"
  "one.ablaze.floorp"
  "app.zen_browser.zen"
  "org.torproject.torbrowser-launcher"
  "org.chromium.Chromium"
  "com.brave.Browser"
  "io.github.ungoogled_software.ungoogled_chromium"
  "com.vivaldi.Vivaldi"
  "com.opera.Opera"
  "com.microsoft.Edge"
  "com.google.Chrome"
  "org.kde.falkon"
  "org.gnome.Epiphany"
  "re.sonny.Tangram"
)

for APP in "${REG_FLATPAK_APPS_UPDATE[@]}"; do
  /usr/bin/flatpak update --assumeyes --noninteractive "$APP"
done


notifyAll() {
  for SOME_USER in /run/user/*; do
    SOME_USER=$(basename "$SOME_USER")
    sudo -u $(id -u -n "$SOME_USER") \
        DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/"$SOME_USER"/bus notify-send -a "CatCat OS Update" -i '/usr/share/pixmaps/catcat-os-logo.svg' "$1"
  done
}


# two weeks = 1209600
# one week = 604800
# update if system is one weeks old
if [[ $(stat -c "%Y" /etc/catcat-os/last-auto-update.log) -lt $(( $(date +%s) - 604800 )) ]]; then
  notifyAll "Automatic weekly update has started."

  date "+%a %b %d %H:%M:%S %Y" > /etc/catcat-os/last-auto-update.log

  /usr/bin/update extra >> /etc/catcat-os/last-auto-update.log

  if [[ $(stat -c "%Y" /etc/catcat-os/update_sha) -lt $(( $(date +%s) - 604800 )) ]]; then
    /usr/bin/update >> /etc/catcat-os/last-auto-update.log
  fi

  notifyAll "Automatic weekly update is done."
fi

